!function(t){function e(e){for(var i,o,s=e[0],l=e[1],c=e[2],d=0,f=[];d<s.length;d++)o=s[d],n[o]&&f.push(n[o][0]),n[o]=0;for(i in l)Object.prototype.hasOwnProperty.call(l,i)&&(t[i]=l[i]);for(u&&u(e);f.length;)f.shift()();return r.push.apply(r,c||[]),a()}function a(){for(var t,e=0;e<r.length;e++){for(var a=r[e],i=!0,s=1;s<a.length;s++){var l=a[s];0!==n[l]&&(i=!1)}i&&(r.splice(e--,1),t=o(o.s=a[0]))}return t}var i={},n={2:0},r=[];function o(e){if(i[e])return i[e].exports;var a=i[e]={i:e,l:!1,exports:{}};return t[e].call(a.exports,a,a.exports,o),a.l=!0,a.exports}o.m=t,o.c=i,o.d=function(t,e,a){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(o.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(a,i,function(e){return t[e]}.bind(null,i));return a},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="./";var s=window.webpackJsonp=window.webpackJsonp||[],l=s.push.bind(s);s.push=e,s=s.slice();for(var c=0;c<s.length;c++)e(s[c]);var u=l;r.push([7,0,1]),a()}({28:function(t,e){},7:function(t,e,a){"use strict";(function(t){a(2),a(3),a(6),a(21),a(26),a(28);var e=a(4),i=a(9),n=a(5),r={0:"未分析",1:"分析中",2:"分析成功",3:"分析失败"},o=[],s=[],l={},c="",u=function(){return"没有找到匹配的记录"};t("#tb_patients").bootstrapTable({data:[],striped:!0,singleSelect:!0,pageSize:10,formatNoMatches:u,columns:[{title:"序号",formatter:function(t,e,a){return a+1}},{field:"series.patient.patientId",title:"患者编码"},{field:"series.patient.patientName",title:"姓名"},{field:"series.patient.patientGender",title:"性别",formatter:function(t,e,a){return"F"==t?"女":"M"==t?"男":"其它"}},{field:"series.studyAge",title:"年龄"},{field:"series.seriesDate",title:"检查日期"},{field:"series.seriesTime",title:"检查时间"},{field:"series.modality",title:"设备"},{field:"series.seriesDescription",title:"描述"},{field:"series.imageCount",title:"张数"},{field:"analyzeStatus",title:"分析状态",class:"status",formatter:function(t,e,a){return r[t]}},{field:"analyzeResultKey",title:"操作",formatter:function(t,e,a){return'<a class="showTip" data-status='+e.analyzeStatus+" analyzeResultKey="+t+" seriesKey="+e.seriesKey+'>分析</a> | <a class="showData" data-status='+e.analyzeStatus+" analyzeResultKey="+t+" seriesKey="+e.seriesKey+">查看</a>"}}]}),sessionStorage.getItem("login")||(window.location.href="/login.html"),t.get(e+"/user/me").done(function(e){e.data||(window.location.href="/login.html"),t("header span b").html(" "+e.data.username+" ").css("cursor","pointer").click(function(){window.open("/userInfo.html")})}).fail(function(t){});var d=function(a){t("#tb_patients").bootstrapTable("showLoading"),t.post(e+"/user/list").done(function(e){t("#tb_patients").bootstrapTable("hideLoading"),e.data?a?(e.data.analyzeStatus=1,t("#tb_patients").bootstrapTable("load",[e.data]),a(e.data.analyzeResultKey)):t("#tb_patients").bootstrapTable("load",[e.data]):t("#tb_patients").bootstrapTable("load",[])}).fail(function(e){t("#tb_patients").bootstrapTable("hideLoading"),t("#tb_patients").bootstrapTable("load",[])})};d();var f=null;t(".upload-btn").click(function(){o=[],l={},c="",t(".directory").file&&(t(".directory").file=[]),t(".directory").val(""),t(".directory").click()});var p=[];t(".analysis-btn").click(function(){if(p=[],!c)return alert("请选择某一序列影像数据进行上传并分析!");l[c].forEach(function(t){p.push(t.file)}),t(".suv-param").show();var e=l[c][0],a=e.patientWeight,i=e.radiopharmaceutical,n=void 0===i?"radiopharmaceutical":i,r=(e.radiopharmaceuticalStartDate,e.radiopharmaceuticalStartTime),o=void 0===r?"085200":r,s=e.acquisitionTime,u=e.radionuclideHalfLife,d=void 0===u?"":u,f=e.radionuclideTotalDose,b=void 0===f?"":f,g=e.typeOfDicom,h=o.substr(0,4)+"/"+o.substr(4,2)+"/"+o.substr(6,2)+" "+o.substr(8,2)+":"+o.substr(10,2)+":"+o.substr(12,2),y=o.substr(0,4)+"/"+o.substr(4,2)+"/"+o.substr(6,2)+" "+s.substr(0,2)+":"+s.substr(2,2)+":"+s.substr(4,2),v=parseInt((new Date(y)-new Date(h))/1e3);t("#patientWeight").val(a),t("#imagingInterval").val(v),t("#radionuclideHalfLife").val(d),t("#radionuclideTotalDose").val(b),t("#radiopharmaceutical").val(n),"PT"==g?t(".suv-param-modal").modal("show"):m("OTHER")});var m=function(a){var i=t("#patientWeight").val()||"0",r=t("#imagingInterval").val()||0,o=t("#radionuclideHalfLife").val()||"0",s=t("#radionuclideTotalDose").val()||"0",l=t("#radiopharmaceutical").val();if("OTHER"!==a){if(i<=0)return n.error("请输入正确的体重！");if(r<=0)return n.error("请输入正确的注射时差！");if(r.match(/\./g)&&r.match(/\./g).length>=1)return n.error("注射时差应为正整数！");if(o<=0)return n.error("请输入正确的核素半衰期！");if(s<=0)return n.error("请输入正确的注射剂量！")}var c=new FormData;t(".suv-param-modal").modal("hide"),t(".progress-box").show(),p.forEach(function(t){c.append("uploadingFiles",t)}),c.append("patientWeight",i),c.append("imagingInterval",Number(r)),c.append("radionuclideHalfLife",o),c.append("radionuclideTotalDose",s),c.append("radiopharmaceutical",l),c.append("radiopharmaceuticalStartDate","20120319"),c.append("radiopharmaceuticalStartTime","085200"),t(void 0).addClass("disabled"),f=t.ajax({url:e+"/user/upload",type:"post",data:c,processData:!1,contentType:!1,success:function(e){200==e.code&&e.success?(n.success("数据正在自动分析中，请耐心等待。"),t(".progress-box").hide(),f=null,d(g),t(".upload-list-modal").modal("hide")):n.error("上传失败！")},error:function(e){t(".progress-box").hide(),t(this).removeClass("disabled"),500==e.status?n.error("上传失败。"):n.success("上传已取消。")},xhr:function(){var e=t.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var a=Math.floor(e.loaded/e.total*100);a<=100&&t(".progress-box p").css("width",a+"%"),a>=100&&t(".progress-box span").html("文件上传完毕，请等待...")}},!1),e}})};t(".suv-param-modal .confirm-btn").on("click",m),t(".upload-form").on("change",".directory",function(){s=this.files,n.warning("正在解析文件……"),setTimeout(function(){t(s).each(function(e,a){var n=new FileReader;n.onload=function(a){var r=n.result;!function(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";try{var n=i.parseDicom(e),r=n.string("x00080070").match(/GE/)?"GE":"OT",c=n.string("x00100020"),u=n.string("x00100010"),d=n.string("x00100040"),f=n.string("x00101010"),p=n.string("x00101030"),m=n.string("x00080021"),g=n.string("x00080031"),h=n.string("x0008103e"),y=n.string("x0020000e"),v=n.uint16("x00540081")||Number(n.string("x00540081"))||"NA",x=n.string("x00280008")>1?n.string("x00280008"):0,T=n.string("x00200013"),w=n.string("x00080080"),D=n.string("x00080060"),O="PT"==D?1:"NM"==D?2:3,S=n.string("x00080032"),k="GE"!==r?n.string("x00181074"):n.float("x00091038"),N="GE"!==r?n.string("x00181075"):n.float("x0009103f"),_="GE"!==r?n.string("x00180031"):n.string("x00091037"),A="GE"!==r?n.string("x00181072"):n.string("x00091039");l[c+D+y]||(l[c+D+y]=[]),t.inArray(c+D+y,o)||o.push(c+D+y),l[c+D+y].push({manufacturer:r,patientId:c,patientName:u,patientSex:d,patientAge:f,patientWeight:p,seriesDate:m,seriesTime:g,seriesDescription:h,seriesInstanceUID:y,instanceTotal:v,instanceNumber:T,instanceSliceCount:x,institutionName:w,acquisitionTime:S,radionuclideTotalDose:k?k.toFixed(1):"",radionuclideHalfLife:N?N.toFixed(1):"",radiopharmaceutical:_,radiopharmaceuticalStartTime:A,typeOfDicom:D,order:O,file:s[a]}),a==s.length-1&&(t("#patientWeight").val(p),t("#imagingInterval").val(A-S),t("#radionuclideHalfLife").val(N),t("#radionuclideTotalDose").val(k),b())}catch(t){0==Object.keys(l).length&&a==s.length-1&&b()}}(new Uint8Array(r),e)},n.readAsArrayBuffer(a)})},400)});var b=function(){var e=new Array;if(Object.keys(l).forEach(function(t,a){l[t][0].instanceSliceCount?e[a]=Object.assign({},l[t][0],{instanceNumber:l[t][0].instanceSliceCount+"/"+l[t][0].instanceTotal}):e[a]=Object.assign({},l[t][0],{instanceNumber:l[t].length+"/"+l[t][0].instanceTotal})}),0!=s.length){if(0==e.length)return n.error("您选择的路径中没有可处理的Dicom数据，请重新选择需要处理的数据");t(".upload-list-modal").modal("show"),t("#upload_lists").bootstrapTable({data:e,striped:!0,singleSelect:!0,pagination:!0,pageSize:10,pageList:[10,25],clickToSelect:!0,sortName:"order",sortOrder:"asc",formatNoMatches:u,columns:[{field:"order",title:"",visible:!1},{checkbox:!0,formatter:function(t,e,a){return"PT"==e.typeOfDicom||"NM"==e.typeOfDicom?{disabled:!1}:{disabled:!0}}},{field:"patientId",title:"患者编码"},{field:"patientName",title:"姓名"},{field:"patientSex",title:"性别",formatter:function(t,e,a){return"F"==t?"女":"M"==t?"男":"其它"}},{field:"patientAge",title:"年龄"},{field:"seriesDate",title:"检查日期"},{field:"seriesTime",title:"检查时间"},{field:"typeOfDicom",title:"设备",formatter:function(t,e,a){return"PT"==e.typeOfDicom&&(t="PET"),"NM"==e.typeOfDicom&&(t="SPECT"),t}},{field:"seriesDescription",title:"描述"},{field:"instanceNumber",title:"张数"}],onCheck:function(t){c=t.patientId+t.typeOfDicom+t.seriesInstanceUID},onUncheck:function(t){c=""}}),t("#upload_lists").bootstrapTable("refresh")}},g=function(a){t.post(e+"/analysis/analyzing",{analyzeResultKey:a}).then(function(t){d()}).fail(function(t){})};t(".table").on("click",".showTip",function(e){var a=e.target,i=a.getAttribute("data-status"),r=a.getAttribute("analyzeResultKey"),o=t(a).parents("tr").find(".status");switch(Number(i)){case 0:n.confirm({tit:"分析",content:"是否对该数据进行分析，请确认。"},function(t){t&&(n.confirmOnly({tit:"提示",content:"该数据正在分析中，请耐心等待。"}),o.html("分析中"),a.setAttribute("data-status",1),g(r))});break;case 1:n.confirmOnly({tit:"提示",content:"该数据正在分析中，请耐心等待。"});break;case 2:n.confirm({tit:"提示",content:"该数据已完成分析，是否要重新分析？"},function(t){t&&(n.confirmOnly({tit:"提示",content:"该数据正在分析中，请耐心等待。"}),o.html("分析中"),a.setAttribute("data-status",1),d(g))});break;case 3:n.confirm({tit:"提示",content:"是否对该数据进行分析，请确认。"},function(t){t&&(n.confirmOnly({tit:"提示",content:"该数据正在分析中，请耐心等待。"}),o.html("分析中"),a.setAttribute("data-status",1),d(g))})}}),t(".table").on("click",".showData",function(t){var e=t.target,a=e.getAttribute("data-status"),i=e.getAttribute("analyzeResultKey"),r=e.getAttribute("seriesKey");switch(Number(a)){case 0:n.confirmOnly({tit:"提示",content:"该数据还未进行分析，无法查看分析结果。"});break;case 1:n.confirmOnly({tit:"提示",content:"该数据正在分析中，请耐心等待。"});break;case 2:window.open("/view.html?analyzeResultKey="+i+"&seriesKey="+r,"_blank");break;case 3:n.confirmOnly({tit:"提示",content:"该数据分析失败，无法查看分析结果，请尝试重新分析。"})}}),t(".upload-list-modal").on("hide.bs.modal",function(e){f&&f.abort();var a=t(".directory").clone();t(".directory").remove(),a.value="",a.appendTo(t(".upload-form .form-group")),t("#upload_lists").bootstrapTable("destroy"),o=[],s=[],p=[],l={},c=""})}).call(this,a(0))}});