!function(e){function a(a){for(var n,l,r=a[0],s=a[1],c=a[2],u=0,m=[];u<r.length;u++)l=r[u],i[l]&&m.push(i[l][0]),i[l]=0;for(n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n]);for(d&&d(a);m.length;)m.shift()();return o.push.apply(o,c||[]),t()}function t(){for(var e,a=0;a<o.length;a++){for(var t=o[a],n=!0,r=1;r<t.length;r++){var s=t[r];0!==i[s]&&(n=!1)}n&&(o.splice(a--,1),e=l(l.s=t[0]))}return e}var n={},i={5:0},o=[];function l(a){if(n[a])return n[a].exports;var t=n[a]={i:a,l:!1,exports:{}};return e[a].call(t.exports,t,t.exports,l),t.l=!0,t.exports}l.m=e,l.c=n,l.d=function(e,a,t){l.o(e,a)||Object.defineProperty(e,a,{enumerable:!0,get:t})},l.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.t=function(e,a){if(1&a&&(e=l(e)),8&a)return e;if(4&a&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(l.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&a&&"string"!=typeof e)for(var n in e)l.d(t,n,function(a){return e[a]}.bind(null,n));return t},l.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return l.d(a,"a",a),a},l.o=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)},l.p="./";var r=window.webpackJsonp=window.webpackJsonp||[],s=r.push.bind(r);r.push=a,r=r.slice();for(var c=0;c<r.length;c++)a(r[c]);var d=s;o.push([11,0,1]),t()}({11:function(e,a,t){"use strict";(function(e){t(2),t(3),t(6),t(21),t(26),t(38);var a=t(12),n=t(15),i=t(16),o=t(17),l=t(18),r=t(4),s=t(19),c=t(5);o.external.cornerstoneMath=i,o.external.cornerstone=n,o.external.Hammer=l,window.cornerstone=n,window.cornerstoneTools=o,String.prototype.queryURLParameter=function(){var e={},a=/([^?&=#]+)=([^?&=#]+)/g;return this.replace(a,function(){e[arguments[1]]=arguments[2]}),(a=/#([^?&=#]+)/).test(this)&&(e.HASH=a.exec(this)[1]),e};var d=Number(window.location.href.queryURLParameter().analyzeResultKey),u=Number(window.location.href.queryURLParameter().seriesKey);sessionStorage.getItem("login")||(window.location.href="/login.html"),e.get(r+"/user/me").done(function(a){a.data||(window.location.href="/login.html"),e("header span b").html(" "+a.data.username+" ").css("cursor","pointer").click(function(){window.open("/userInfo.html")})});var m="PET";e.post(r+"/analysis/dcmInfo",{seriesKey:u}).done(function(a){"PET"!==a.modality&&(m="NoPET",e(".suvParam-btn").addClass("disabled"),e(".acount").empty().append('<option value="BQ">光子计数统计</option>'),e(".modeType").empty().append('<option value="BOTH">全部</option><option value="-">血流减低</option><option value="+">血流增高</option>')),a.patient.patientBirthDate&&a.acquisitionDate?e(".dicomInfo.img-patient").html(a.patient.patientName+" "+a.patient.patientId+"( "+((new Date).getFullYear()-a.patient.patientBirthDate.slice(0,4))+"Y, "+(a.acquisitionDate.slice(0,4)-a.patient.patientBirthDate.slice(0,4))+"Y )"):e(".dicomInfo.img-patient").html(a.patient.patientName+" "+a.patient.patientId+"( -Y, -Y )"),e(".dicomInfo").find(".time").html(a.acquisitionDate.replace("T"," ").substr(0,19)),e(".dicomInfo.img-series").html(a.seriesDescription),e("#analysis-table").bootstrapTable({data:[],striped:!0,singleSelect:!0,pagination:!1,height:420,formatNoMatches:We,formatLoadingMessage:Ae,columns:[{title:"编码",formatter:function(e,a,t){return t+1}},{field:"volume",title:"病灶体积(mm³)"},{field:"zscore",title:"病灶程度(ZScore)"},{field:"xyz",title:"病灶MNI坐标"},{field:"cerebellumCompareMax",title:"小脑比(极值)"},{field:"cerebellumCompareAvg",title:"小脑比(均值)"},{field:"oppositeCompareAvg",title:"对侧比(均值)"},{field:"atlasName",title:"包含功能区",formatter:function(e,a,t){var n=e.slice(0,4);return 4==n.length&&n.splice(3,1,"..."),n.toString().replace(/,/g,"，")}}]}),e("#half-analysis-table").bootstrapTable({data:[],striped:!0,singleSelect:!0,pagination:!1,height:420,formatNoMatches:We,formatLoadingMessage:Ae,columns:[{title:"编码",formatter:function(e,a,t){return t+1}},{field:"name",title:"脑功能区"},{field:"oppositeCompareAvg",title:"对侧比(均值)"},{field:"leftCerebellumCompareMax",title:"左小脑比(最大值)"},{field:"rightCerebellumCompareMax",title:"右小脑比(最大值)"},{field:"leftCerebellumCompareAvg",title:"左小脑比(均值)"},{field:"rightCerebellumCompareAvg",title:"右小脑比(均值)"},{field:"allBrainAtlasCompareMax",title:"全脑比(最大值)"},{field:"allBrainAtlasCompareAvg",title:"全脑比(均值)"},{field:"suvMax",title:"SUV(最大值)",visible:"PET"===m},{field:"suvAvg",title:"SUV(均值)",visible:"PET"===m},{field:"max",title:"BQ(最大值)"},{field:"avg",title:"BQ(均值)"},{field:"normalControlAvg",title:"与正常人SUV比(均值)",visible:"PET"===m}]})});var p=void 0,h=void 0,f=void 0,v=void 0,g=void 0,w=void 0,b=[],y=[],I=!0,x=!0,C=!0,z={x:50,y:50,z:50},T={x:50,y:50,z:50},k={wc:0,ww:0},S=0,P=255,D=["transect","coronal","sagittal"],E=function(e){this.type=e.type,this.transect={translation:{x:0,y:0},scale:1,voi:e.voi||{windowWidth:0,windowCenter:255},imageIndex:1},this.coronal={translation:{x:0,y:0},scale:1,voi:e.voi||{windowWidth:0,windowCenter:255},imageIndex:1},this.sagittal={translation:{x:0,y:0},scale:1,voi:e.voi||{windowWidth:0,windowCenter:255},imageIndex:1}},L=new E({type:"norm"}),M=new E({type:"source"}),W=void 0,A=void 0,F=void 0,V=void 0,R=void 0,q=void 0;e(".dicomInfo").find(".WL").html(k.wc),e(".dicomInfo").find(".WW").html(k.ww);var O=e(".canvas-box1 .img-size").find(".size"),j=e(".canvas-box2 .img-size").find(".size"),K=e(".canvas-box3 .img-size").find(".size"),N=e(".dicomInfo").find(".thickness"),H=e(".btn-content"),U=e(".mask");!function(t,n){U.css("display","flex").find("span").html("预处理图像"),e.ajax({url:t,type:"post",data:{analyzeResultKey:n},dataType:"json",cache:!0}).done(function(t){k={wc:parseInt(t.data.wc),ww:parseInt(t.data.ww)},Object.freeze(k),M.voi={windowCenter:parseInt(t.data.wc),windowWidth:parseInt(t.data.ww)},L.voi={windowCenter:parseInt(t.data.wc),windowWidth:parseInt(t.data.ww)},S=k.wc-k.ww/2,P=k.wc+k.ww/2;var i=t.data;V=i.inter,R=i.slope,q=i.pixDim,4==i.sourceDim.length&&i.sourceDim.pop(),h=a(i.source,i.sourceDim),p=G(h,"source"),function(t,n){U.find("span").html("归一化图像"),e.ajax({url:t,type:"get",data:{analyzeResultKey:n},dataType:"json",cache:!0}).done(function(e){var t=e.data;W=t.inter,A=t.slope,F=t.pixDim,4==t.normDim.length&&t.normDim.pop(),v=a(t.norm,t.normDim),f=G(v,"norm"),O.html(t.normDim[0]+"*"+t.normDim[1]),j.html(t.normDim[0]+"*"+t.normDim[2]),K.html(t.normDim[1]+"*"+t.normDim[0]),N.html(F[2]),de("norm")})}(r+"/analysis/norm",n)})}(r+"/analysis/dicom",d);var B="norm",_=function(){var e="norm"==B?L:M;ae.forEach(function(a,t){var i=a.element,o=a.viewport;1!==e[D[t]].scale?(o.voi=e[D[t]].voi,o.scale=e[D[t]].scale,o.translation=e[D[t]].translation):(o.voi=e.voi,o.scale=e.defaultScale,o.translation={x:0,y:0}),n.setViewport(i,o)})};e(".type-container .type").click(function(){if(!g||!b.length)return alert("请等待全部数据加载完成。");var a=e(this);if(B!=a.attr("data-type")){B=a.attr("data-type"),a.addClass("active").siblings(".type").removeClass("active"),H.find(".btn").removeClass("active"),be="",Le="",H.find(".window-btn").addClass("active"),"11"==pe&&(pe="nm",e(".layout-btn").click());var t=new Promise(function(e,a){de(B)});"norm"==B?(qe.prop({disabled:!1}),Oe.prop({disabled:!1}),t.then(function(){return _()}),O.html(v.shape[0]+"*"+v.shape[1]),j.html(v.shape[0]+"*"+v.shape[2]),K.html(v.shape[1]+"*"+v.shape[0]),N.html(F[2])):(qe.prop({disabled:!0}),Oe.prop({disabled:!0}),t.then(function(){return _()}),O.html(h.shape[0]+"*"+h.shape[1]),j.html(h.shape[0]+"*"+h.shape[2]),K.html(h.shape[1]+"*"+h.shape[0]),N.html(q[2]))}});var Y=function(e,a,t){var n=255/(e-a);if(t<a)return 0;if(t>e)return 255;var i=(t-a)*n;return i<0?0:i>255?255:i},Q=[[0,0,170,255],[0,0,255,255],[0,85,255,255],[0,170,255,255],[0,255,255,255],[85,255,170,255],[170,255,85,255],[255,255,0,255],[255,170,0,255],[255,85,0,255],[255,0,0,255]],J=function(e){var a=Math.round(e);return"0.0"==e?[0,0,0,0]:a<-5?Q[0]:a>5?Q[10]:Q[a+5]},Z=function(e,a,t,n,i,o){for(var l=0;l<e.shape[0];l++)for(var r=0;r<e.shape[1];r+=1)if("norm"==o)t.data[4*(l*e.shape[1]+r)+0]=e.get(l,r),t.data[4*(l*e.shape[1]+r)+1]=e.get(l,r),t.data[4*(l*e.shape[1]+r)+2]=e.get(l,r),t.data[4*(l*e.shape[1]+r)+3]=255;else if("brain"==o){var s=(h=e.get(l,r),v=void 0,f=(f=void 0)||1,(v=v||0)+(h=(9301*h+49297)%233280)/233280*(f-v)),c=parseInt(16777216*s),d=c%256,u=c/256%256,m=c/256/256;t.data[4*(l*e.shape[1]+r)+0]=d,t.data[4*(l*e.shape[1]+r)+1]=u,t.data[4*(l*e.shape[1]+r)+2]=m,0==e.get(l,r)?t.data[4*(l*e.shape[1]+r)+3]=0:t.data[4*(l*e.shape[1]+r)+3]=255}else{var p=J(e.get(l,r));t.data[4*(l*e.shape[1]+r)+0]=p[0],t.data[4*(l*e.shape[1]+r)+1]=p[1],t.data[4*(l*e.shape[1]+r)+2]=p[2],t.data[4*(l*e.shape[1]+r)+3]=p[3]}var h,f,v;return a.getContext("2d").clearRect(0,0,e.shape[1],e.shape[0]),a.getContext("2d").putImageData(t,0,0),"norm"==o?t:a.toDataURL("image/webp")},G=function(a,t){"norm"==t?z={x:Math.round(a.shape[0]/2),y:Math.round(a.shape[1]/2),z:Math.round(a.shape[2]/2)}:"source"==t&&(T={x:Math.round(a.shape[0]/2),y:Math.round(a.shape[1]/2),z:Math.round(a.shape[2]/2)});var n=a.shape[0]+a.shape[1]+a.shape[2];return e(".progress-box").hide(),{TransectPanels:function(){for(var i=[],o=[],l=a.pick(0,null,null),r=l.shape[1],s=l.shape[0],c=0;c<a.shape[2];c++){if(l=a.pick(c,null,null),"norm"==t||"source"==t){for(var d=new Uint16Array(r*s),u=0,m=0;m<s;m++)for(var p=0;p<r;p++)d[u]=Math.max(parseInt(l.get(m,p)),0),u++;i[a.shape[2]-1-c]=d}else{var h=e('<canvas id="dcmCanvas1" width="'+r+'" height="'+s+'"></canvas>')[0],f=h.getContext("2d").createImageData(r,s);i[a.shape[2]-1-c]=Z(l,h,f,0,0,t)}var v=(100*c/n).toFixed(0)+"%";e(".progress-box").css("width",v)}for(var g=0;g<a.shape[2];g++)o.push("newImageLoader://transect"+t+g);return{panels:i,shape:l.shape,imageIds:o}}(),CoronalPanels:function(){for(var i=[],o=[],l=a.pick(null,0,null),r=l.shape[1],s=l.shape[0],c=0;c<a.shape[1];c++){if(l=a.pick(null,c,null),"norm"==t||"source"==t){for(var d=new Uint16Array(r*s),u=0,m=0;m<s;m++)for(var p=0;p<r;p++)d[u]=Math.max(parseInt(l.get(m,p)),0),u++;i[a.shape[1]-1-c]=d}else{var h=e('<canvas id="dcmCanvas2" width="'+r+'" height="'+s+'"></canvas>')[0],f=h.getContext("2d").createImageData(r,s);i[a.shape[1]-1-c]=Z(l,h,f,0,0,t)}var v=(100*(a.shape[0]+c)/n).toFixed(0)+"%";e(".progress-box").css("width",v)}for(var g=0;g<a.shape[1];g++)o.push("newImageLoader://coronal"+t+g);return{panels:i,shape:l.shape,imageIds:o}}(),SagittalPanels:function(){for(var i=[],o=[],l=a.pick(null,null,0),r=l.shape[1],s=l.shape[0],c=0;c<a.shape[0];c++){if(l=a.pick(null,null,c),"norm"==t||"source"==t){for(var d=new Uint16Array(r*s),u=0,m=0;m<s;m++)for(var p=0;p<r;p++)d[u]=Math.max(parseInt(l.get(m,p)),0),u++;i[c]=d}else{var h=e('<canvas id="dcmCanvas3" width="'+r+'" height="'+s+'"></canvas>')[0],f=h.getContext("2d").createImageData(r,s);i[c]=Z(l,h,f,0,0,t)}var v=(100*(a.shape[0]+c)/n).toFixed(0)+"%";e(".progress-box").css("width",v)}for(var g=0;g<a.shape[0];g++)o.push("newImageLoader://sagittal"+t+g);return{panels:i,shape:l.shape,imageIds:o}}()}};n.registerImageLoader("newImageLoader",function(e){var a=e.match(/\/+[a-zA-Z]*/)[0].slice(2),t=e.match(/[0-9]\d*/)[0],i=void 0;"norm"==B?a=="transect"+B?i=f.TransectPanels:a=="coronal"+B?i=f.CoronalPanels:a=="sagittal"+B&&(i=f.SagittalPanels):a=="transect"+B?i=p.TransectPanels:a=="coronal"+B?i=p.CoronalPanels:a=="sagittal"+B&&(i=p.SagittalPanels);var o=i.shape[1],l=i.shape[0],r={imageId:e,minPixelValue:S,maxPixelValue:P,slope:"norm"==B?A:R,intercept:"norm"==B?W:V,windowCenter:k.wc,windowWidth:k.ww,render:n.renderGrayscaleImage,getPixelData:function(){return i.panels[t].data||i.panels[t]},rows:l,columns:o,height:l,width:o,color:!1,columnPixelSpacing:1.5,rowPixelSpacing:1.5,invert:!1,sizeInBytes:o*l*2,rgba:!0};return{promise:new Promise(function(e){return e(r)}),cancelFn:void 0}});var X=e(".transect")[0],$=e(".coronal")[0],ee=e(".sagittal")[0];n.enable(X,{renderer:"webgl"}),n.enable($,{renderer:"webgl"}),n.enable(ee,{renderer:"webgl"});var ae=n.getEnabledElements(),te=void 0,ne=void 0,ie=void 0,oe=void 0,le={transect:te,coronal:ne,sagittal:ie},re={transect:te,coronal:ne,sagittal:ie};o.mouseInput.enable(X),o.touchInput.enable(X),o.mouseWheelInput.enable(X),o.mouseInput.enable($),o.touchInput.enable($),o.mouseWheelInput.enable($),o.mouseInput.enable(ee),o.touchInput.enable(ee),o.mouseWheelInput.enable(ee);var se=new o.Synchronizer("cornerstoneimagerendered",o.wwwcSynchronizer),ce=function(e,a){n.loadImage(e).then(function(e){n.displayImage(a,e)})},de=function(a){var t="norm"==a?f:p,i="norm"==a?z:T,l={currentImageIdIndex:i.z,imageIds:t.TransectPanels.imageIds,label:a},r={currentImageIdIndex:i.y,imageIds:t.CoronalPanels.imageIds,label:a},s={currentImageIdIndex:i.x,imageIds:t.SagittalPanels.imageIds,label:a},c=[{element:X,stack:l,type:"transect"},{element:$,stack:r,type:"coronal"},{element:ee,stack:s,type:"sagittal"}],d=ce("newImageLoader://transect"+B+i.z,X),u=ce("newImageLoader://coronal"+B+i.y,$),m=ce("newImageLoader://sagittal"+B+i.x,ee);Promise.all([d,u,m]).then(function(){te=n.getViewport(X),ne=n.getViewport($),ie=n.getViewport(ee);var t=Math.min(te.scale,ne.scale,ie.scale);oe=t;var l="norm"==a?L:M;l.defaultScale||(l.defaultScale=t);for(var r=function(t){var r=c[t],s=r.element,d=r.stack,u=r.type,m=n.getViewport(s),p=e(s).parent().find("input"),h=e(s).parent().find(".img-count"),f=e(s).parent().find(".img-ww"),v=e(s).parent().find(".zoom");m.rotation=180,1==l[u].scale?(m.scale=l.defaultScale,m.translation={x:0,y:0},l[u].scale=m.scale,l[u].translation=m.translation):(m.scale=l[u].scale,m.translation=l[u].translation),v.html(parseInt(100*m.scale)+"%"),"norm"!=a||le[u]?"source"!=a||re[u]||(re[u]=m):le[u]=m,o.addStackStateManager(s,["stack","linkedStacks"]),se.add(s),o.addToolState(s,"stack",d),"transect"==u?(p.attr({max:d.imageIds.length,title:i.z+1}).val(i.z+1),h.find(".cur-img").html(i.z+1).siblings(".count").html(d.imageIds.length),m.hflip=!0):"coronal"==u?(p.attr({max:d.imageIds.length,title:i.y+1}).val(i.y+1),h.find(".cur-img").html(i.y+1).siblings(".count").html(d.imageIds.length),m.hflip=!0):"sagittal"==u&&(p.attr({max:d.imageIds.length,title:i.x+1}).val(i.x+1),h.find(".cur-img").html(i.x+1).siblings(".count").html(d.imageIds.length),C?e(".dicomInfo").show():e(".dicomInfo").hide()),n.setViewport(s,m),o.stackScrollWheel.activate(s),o.pan.activate(s,2),o.wwwc.activate(s,1),o.zoom.activate(s,4);var w=function(){e(".btn-content .btn").removeClass("active"),o.stackScroll.deactivate(s,1),o.zoom.deactivate(s,1),o.wwwc.deactivate(s,1),o.pan.deactivate(s,1)};e(".window-btn").click(function(){w(),e(this).addClass("active"),o.pan.activate(s,2),o.wwwc.activate(s,1),o.zoom.activate(s,4),e(this).find("ul").show().find("li").click(function(){if(e(this).hasClass("customize")){var a=n.getViewport(s);e(this).addClass("active").siblings().removeClass("active"),e(".window-modal").modal("show"),e(".window-modal").find("#window_width").val(parseInt(a.voi.windowWidth)),e(".window-modal").find("#window_level").val(parseInt(a.voi.windowCenter))}else{e(this).addClass("active").siblings().removeClass("active");var t=n.getViewport(s);t.voi.windowWidth=k.ww,t.voi.windowCenter=k.wc,se.add(s),n.setViewport(s,t)}})}).on("mouseleave",function(){e(this).find("ul").hide()}),e(".zoom-btn").click(function(){w(),e(this).addClass("active"),o.pan.activate(s,2),o.zoom.activate(s,1)}),e(".move-btn").click(function(){w(),e(this).addClass("active"),o.zoom.activate(s,4),o.pan.activate(s,1)}),e(".mpr-btn").click(function(){w(),e(this).addClass("active"),o.stackScroll.activate(s,1),o.pan.activate(s,2),o.zoom.activate(s,4)}),e(s).on(" cornerstonetoolsmousedrag",function(){be="",Le=""}),e(s).on("cornerstonetoolsmousedoubleclick",function(){var a=s.parentElement,t=ue(),n=document.webkitCurrentFullScreenElement;n||e(".canvas-box").attr({width:e(a).outerWidth(),height:e(a).outerHeight()}).css({width:e(a).outerWidth(),height:e(a).outerHeight()});var i=s.requestFullScreen||s.webkitRequestFullScreen||s.mozRequestFullScreen||s.msRequestFullScreen;t&&!n&&i.call(a),n&&(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen())});var y=null;e(s).on("cornerstoneimagerendered",function(){be="",Le="";var e=o.getToolState(this,"stack").data[0].currentImageIdIndex;p.attr("title",e+1).val(e+1),h.find(".cur-img").html(e+1);var a=n.getViewport(s);f.find(".WW").html(parseInt(a.voi.windowWidth)).siblings(".WL").html(parseInt(a.voi.windowCenter));var t="norm"==B?L:M;t[u].voi=a.voi,t[u].translation=a.translation,t[u].scale=a.scale,v.html(parseInt(100*a.scale)+"%");var i="norm"==B?z:T;"transect"==u?i.z=e:"coronal"==u?i.y=e:"sagittal"==u&&(i.x=e),"norm"==B&&(clearTimeout(y),y=setTimeout(function(){"transect"==u?(x&&g&&ye(fe,"TransectPanels",e),I&&b.length&&Me(fe,"TransectPanels",e)):"coronal"==u?(x&&g&&ye(ve,"CoronalPanels",e),I&&b.length&&Me(ve,"CoronalPanels",e)):"sagittal"==u&&(x&&g&&ye(ge,"SagittalPanels",e),I&&b.length&&Me(ge,"SagittalPanels",e)),clearTimeout(y),y=null},10))}),p.on("input",function(){var a=Number(e(this).val());be="",ce("newImageLoader://"+u+B+(a-1),s),o.getToolState(s,"stack").data[0].currentImageIdIndex=a-1,Le=""})},s=0;s<c.length;s++)r(s);"norm"==B&&(Re(),g||we())})},ue=function(){return document.fullscreenEnabled||window.fullScreen||document.webkitFullscreenEnabled||document.webkitIsFullScreen||document.msFullscreenEnabled},me=function(a){var t=ue(),i=document.webkitCurrentFullScreenElement,o=a.parentElement;t&&o==i?(a.style.width=e(o).width()+"px",a.style.height=e(o).height()+"px"):(a.style.width=e(o).attr("width")+"px",a.style.height=e(o).attr("height")+"px"),n.resize(a),n.fitToWindow(a),n.updateImage(a);var l=n.getViewport(a);l.scale=oe,n.setViewport(a,l)};e(window).on("fullscreenchange webkitfullscreenchange mozfullscreenchange msfullscreenchange",function(){me(X),me($),me(ee)}),e(".reverse-btn").click(function(){n.getEnabledElements().forEach(function(e,a){var t=e.element,i=e.viewport;i.invert=!i.invert,n.setViewport(t,i)})}),e(".reset-btn").click(function(){var e="norm"==B?L:M;n.getEnabledElements().forEach(function(a,t){var i=a.element,o=a.viewport;o.translation={x:0,y:0},o.scale=e.defaultScale,o.voi.windowWidth=k.ww,o.voi.windowCenter=k.wc,se.add(i),n.setViewport(i,o)})});var pe="nm",he="";e(".layout-btn").click(function(){var a="norm"==B?f:p;if("nm"==pe){if(e("#DICOM").prop("disabled",!0),0!==e(".images-container img").length&&he==B)return e(".canvas-container").hide(),e(".images-container").show(),pe="11";var t=a.TransectPanels.shape,n=e('<canvas width="'+t[1]+'" height="'+t[0]+'"></canvas>')[0],i=n.getContext("2d"),o=n.getContext("2d").createImageData(t[1],t[0]),l="";return e(".canvas-container").hide(),e(".images-container").empty().css("display","flex"),a.TransectPanels.panels.forEach(function(a,t){for(var r=0,s=a.length;r<s;r++){var c=Y(P,S,a[r]);o.data[4*r+0]=c,o.data[4*r+1]=c,o.data[4*r+2]=c,o.data[4*r+3]=255}i.putImageData(o,0,0),l=n.toDataURL("image/webp"),e(".images-container").append('<img src="'+l+'" class="img-fluid img-item '+B+'" />')}),he=B,pe="11"}return e("#DICOM").prop("disabled",!1),e(".canvas-container").css("display","flex"),e(".images-container").hide(),he!=B&&e(".images-container").empty(),he=B,pe="nm"}),e(".brain-btn").click(function(a){e(a.currentTarget).find("ul").show()}).on("mouseleave",function(a){e(a.currentTarget).find("ul").hide()});var fe=e(X).find("canvas")[0].getContext("2d"),ve=e($).find("canvas")[0].getContext("2d"),ge=e(ee).find("canvas")[0].getContext("2d"),we=function(){U.find("span").html("脑图谱"),e.get(r+"/analysis/brainAtlas").done(function(e){e.data.brainAtlasDim.pop(),w=a(e.data.brainAtlas,e.data.brainAtlasDim),g=G(w,"brain"),ye(fe,"TransectPanels",z.z),ye(ve,"CoronalPanels",z.y),ye(ge,"SagittalPanels",z.x),Ee()}),e("#half-analysis-table").bootstrapTable("showLoading"),e.post(r+"/analysis/semiQuantitation",{analyzeResultKey:d,suvThreshold:.4}).done(function(a){var t=a.data;e("#half-analysis-table").bootstrapTable("hideLoading"),e("#half-analysis-table").bootstrapTable("load",t)})},be="",ye=function(a,t,n){if(be!=t){be=t;var i=g[t].panels[n],o=g[t].shape,l=e('<img src="'+i+'" width="'+o[1]+'" height="'+o[0]+'" />')[0];l.onload=function(){a.drawImage(l,0,0),l=null}}},Ie=e(".analysis-form"),xe=Ie.find(".acount"),Ce=Ie.find(".modeType"),ze=Ie.find(".volume"),Te=Ie.find(".p-value"),ke=e("#patientWeight"),Se=e("#imagingInterval"),Pe=e("#radionuclideHalfLife"),De=e("#radionuclideTotalDose"),Ee=function(){U.find("span").html("病灶图"),e("#analysis-table").bootstrapTable("showLoading"),e.post(r+"/analysis/quantitativeHistory",{analyzeResultKey:d}).done(function(t){var n=t.data,i=t.data.fz,o=n.table,l=n.analyzeResult;i.forEach(function(e){e.fzDim.pop();var t=new a(e.fz,e.fzDim),n=G(t,"fz");y.push(t),b.push(n)}),Me(fe,"TransectPanels",z.z),Me(ve,"CoronalPanels",z.y),Me(ge,"SagittalPanels",z.x),xe.val(l.statisticalMethod),Ce.val(l.statisticalMode),ze.val(l.abnormalVolume),Te.val(l.pvalue),ke.val(l.patientWeight),Se.val(l.imagingInterval),Pe.val(l.radionuclideHalfLife),De.val(l.radionuclideTotalDose);var r=[];o.forEach(function(e){r=r.concat(e)}),e("#analysis-table").bootstrapTable("hideLoading"),e("#analysis-table").bootstrapTable("load",r)})},Le="",Me=function(a,t,n){if(Le!=t){Le=t;var i=b[0][t].panels[n],o=b[0][t].shape,l=o[1],r=o[0],s=e('<img src="'+i+'" width="'+l+'" height="'+r+'" />')[0],c="",d=null;b[1]&&(c=b[1][t].panels[n],d=e('<img src="'+c+'" width="'+l+'" height="'+r+'" />')[0]),s.onload=function(){a.drawImage(s,0,0),s=null},d&&(d.onload=function(){a.drawImage(d,0,0),d=null}),U.hide()}},We=function(){return"没有找到匹配的记录"},Ae=function(){return"数据重新计算中，请耐心等待..."};e(".window-modal .confirm-btn").click(function(){var a=parseInt(e("#window_width").val()),t=parseInt(e("#window_level").val());ae.forEach(function(e){var i=e.element,o=e.viewport;o.voi.windowWidth=a,o.voi.windowCenter=t,n.setViewport(i,o)}),e(".window-modal").modal("hide")}),e(".suvParam-btn").click(function(){e(".suv-param-modal").modal("show"),e(".suv-param-modal .confirm-btn").click(function(){var a=e("#patientWeight").val().toString(),t=e("#imagingInterval").val(),n=e("#radionuclideHalfLife").val(),i=e("#radionuclideTotalDose").val();return a<=0?c.error("请输入正确的体重！"):t<=0?c.error("请输入正确的注射时差！"):n<=0?c.error("请输入正确的核素半衰期！"):i<=0?c.error("请输入正确的注射剂量！"):void c.confirm({tit:"确认",content:"该操作将会重新分析数据，是否确定？"},function(o){o&&(e(".mask").show().find("p").html("重新计算中，请耐心等待..."),e(".suv-param-modal").modal("hide"),e.post(r+"/analysis/suvAnalysis",{patientWeight:a,imagingInterval:t,radionuclideHalfLife:n,radionuclideTotalDose:i,analyzeResultKey:d}).done(function(a){d=a.data,window.history.replaceState({},"newResult","view.html?analyzeResultKey="+d+"&seriesKey="+u),Fe(d),Ve(d),e(".mask").hide()}).fail(function(e){}))})})}),e(".analysis-btn").click(function(){if(!b.length)return alert("请等待数据加载完成。");e(".analysis-modal").show();var a=setTimeout(function(){e(".analysis-modal").addClass("show"),clearTimeout(a),a=null},100)}),e(".analysis-modal .close").click(function(){e(".analysis-modal").removeClass("show");var a=setTimeout(function(){e(".analysis-modal").hide(),clearTimeout(a),a=null},100)});var Fe=function(t){b=[],Re();var n=xe.val(),i=Ce.val(),o=Number(ze.val()),l=Number(Te.val()),s=t;e("#analysis-table").bootstrapTable("showLoading"),e.post(r+"/analysis/quantitative",{statisticalMethod:n,statisticalMode:i,abnormalVolume:o,normalControlKey:1,p:l,analyzeResultKey:s}).done(function(t){var n=t.data,i=t.data.fz,o=n.table;i.forEach(function(e){e.fzDim.pop();var t=new a(e.fz,e.fzDim),n=G(t,"fz");y.push(t),b.push(n)}),"norm"==B&&(Le="",Me(fe,"TransectPanels",z.z),Me(ve,"CoronalPanels",z.y),Me(ge,"SagittalPanels",z.x));var l=[];o.forEach(function(e){l=l.concat(e)}),e("#analysis-table").bootstrapTable("hideLoading"),e("#analysis-table").bootstrapTable("load",l)})};e(".analysis-modal .btn-quantitative").click(function(){Fe(d)});var Ve=function(a){var t=Number(e(".half-analysis-suv").val());e("#half-analysis-table").bootstrapTable("showLoading"),e.post(r+"/analysis/semiQuantitation",{analyzeResultKey:a,suvThreshold:t}).done(function(a){e("#half-analysis-table").bootstrapTable("hideLoading"),e("#half-analysis-table").bootstrapTable("load",a.data)})};e(".half-analysis-suv").change(function(){Ve(d)});var Re=function(){n.updateImage(X),n.updateImage($),n.updateImage(ee)},qe=e("#sickArea"),Oe=e("#brain");qe.change(function(){I=!I,Re()}),Oe.change(function(){x=!x,Re()}),e("#DICOM").change(function(){C=!C,e(".dicomInfo").toggle()}),e("body").on("click",".export-btn",function(){for(var a=e(this).parents(".analysis-content").find(".nav-link.active"),t=a.html(),n="#"+a.attr("aria-controls"),i=e(n).find("tr"),o="",l=1;l<i.length;l++){for(var r=i.eq(l).find("td,th"),s=0;s<r.length;s++)o+=r.eq(s).text()+",";o+="\n"}var c="data:text/csv;charset=utf-8,\ufeff"+o,d=document.createElement("a");d.setAttribute("href",c),d.setAttribute("download",t+".csv"),d.click()}),s(e(".analysis-modal").find(".drag-item")[0])}).call(this,t(0))},19:function(e,a,t){"use strict";var n=null,i=function(e){n.style.left=n.offsetLeft+e.movementX+"px",n.style.top=n.offsetTop+e.movementY+"px"};e.exports=function(e){e&&(n=document.querySelector(".drag-container"),e.addEventListener("mousedown",function(a){a.target===e&&(e.addEventListener("mousemove",i,!1),e.addEventListener("mouseup",function(a){e.removeEventListener("mousemove",i)},!1),e.addEventListener("mouseleave",function(a){e.removeEventListener("mousemove",i)},!1))},!1))}},38:function(e,a){}});